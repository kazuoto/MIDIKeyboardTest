<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Low Latency MIDI + Tone.js Sample</title>
</head>
<body>
  <h1>低遅延(っぽい) MIDI + Tone.js ピアノ音源にゃ</h1>
  <!-- ボタンを押すとMIDIアクセス＆オーディオContext開始にゃ -->
  <button id="requestMIDI">MIDI使用許可をリクエストするにゃ</button>

  <!-- Tone.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.27/Tone.min.js"></script>

  <script>
    // 1. latencyHint: 'interactive' なAudioContextを自作
    const lowLatencyContext = new AudioContext({
      latencyHint: 'interactive'
    });

    // 2. Tone.jsが使うオーディオコンテキストを置き換え
    Tone.setContext(lowLatencyContext);

    // 3. Tone.Samplerで「Salamander Piano」音源を読み込む
    //    (C3, C4, C5とかじゃなくて、いっぱい音源があるやつにゃ)
    const sampler = new Tone.Sampler({
      urls: {
        "A0": "A0.mp3",
        "C1": "C1.mp3",
        "D#1": "Ds1.mp3",
        "F#1": "Fs1.mp3",
        "A1": "A1.mp3",
        "C2": "C2.mp3",
        "D#2": "Ds2.mp3",
        "F#2": "Fs2.mp3",
        "A2": "A2.mp3",
        "C3": "C3.mp3",
        "D#3": "Ds3.mp3",
        "F#3": "Fs3.mp3",
        "A3": "A3.mp3",
        "C4": "C4.mp3",
        "D#4": "Ds4.mp3",
        "F#4": "Fs4.mp3",
        "A4": "A4.mp3",
        "C5": "C5.mp3",
        "D#5": "Ds5.mp3",
        "F#5": "Fs5.mp3",
        "A5": "A5.mp3",
        "C6": "C6.mp3",
        "D#6": "Ds6.mp3",
        "F#6": "Fs6.mp3",
        "A6": "A6.mp3",
        "C7": "C7.mp3",
        "D#7": "Ds7.mp3",
        "F#7": "Fs7.mp3",
        "A7": "A7.mp3"
      },
      release: 1,
      baseUrl: "https://tonejs.github.io/audio/salamander/"
    }).toDestination();

    // MIDIノート番号→音名に変換する簡単な関数にゃ
    function midiToNoteName(midiNote) {
      const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
      const octave = Math.floor(midiNote / 12) - 1;
      const note = noteNames[midiNote % 12];
      return note + octave;
    }

    document.getElementById('requestMIDI').addEventListener('click', async () => {
      // 4. ユーザー操作でAudioContextを「resume」 (Chromeなどで必要)
      //    Tone.start() すると内部のAudioContextがunlockedされるにゃ
      await Tone.start();
      console.log("AudioContextがスタートにゃ！", lowLatencyContext.state);

      // 5. MIDIアクセス
      navigator.requestMIDIAccess()
        .then((midiAccess) => {
          alert("MIDIアクセス成功にゃ！弾いてみてにゃ～🐱");

          for (let input of midiAccess.inputs.values()) {
            input.onmidimessage = (msg) => {
              const [status, data1, data2] = msg.data;
              const command = status & 0xf0;
              if (command === 0x90) { // Note On
                if (data2 > 0) {
                  // velocityを第3引数にセット (0～1に正規化)
                  sampler.triggerAttack(midiToNoteName(data1), undefined, data2 / 127);
                } else {
                  // velocity=0ならNoteOffと同じ扱い
                  sampler.triggerRelease(midiToNoteName(data1));
                }
              } else if (command === 0x80) { // Note Off
                sampler.triggerRelease(midiToNoteName(data1));
              }
            };
          }
        })
        .catch((err) => {
          console.error("MIDIアクセス失敗にゃ…", err);
          alert("MIDIアクセスが拒否または失敗したにゃ…");
        });
    });
  </script>
</body>
</html>
