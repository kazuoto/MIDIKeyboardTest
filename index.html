<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AudioWorklet Sample Piano-ish</title>
</head>
<body>
  <h1>AudioWorkletã§ã‚µãƒ³ãƒ—ãƒ«éŸ³æºå†ç”Ÿã«ã‚ƒ(è¶…ç°¡æ˜“ç‰ˆ)</h1>
  <button id="startBtn">ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªï¼†MIDIé–‹å§‹ã«ã‚ƒ</button>

  <script>
    /* 
      â˜…â˜…â˜… äº‹å‰ã«"ã‚µãƒ³ãƒ—ãƒ«éŸ³"ã‚’1å€‹ç”¨æ„ã—ã¦ãŠãã«ã‚ƒ â˜…â˜…â˜…
      ã“ã“ã§ã¯ã€ŒC4ã®ãƒ”ã‚¢ãƒéŸ³ã€ã‚’æƒ³å®šã—ã€
      ä¸‹è¨˜URLã‹ã‚‰é©å½“ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã€ŒC4.mp3ã€ã‚’ä½¿ã†ä¾‹ã«ã™ã‚‹ã«ã‚ƒã€‚
      ã‚ã‚‹ã„ã¯è‡ªåˆ†ã®MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’URLã«æŒ‡å®šã—ã¦ã«ã‚ƒã€‚

      ä¸‹ã¯ã€ŒSalamander Pianoã€å†…ã®C4ã®URLã‚µãƒ³ãƒ—ãƒ«ä¾‹ (ã¡ã‚‡ã£ã¨é•·ã„):
      "https://tonejs.github.io/audio/salamander/C4.mp3"
    */
    const SAMPLE_URL = "https://tonejs.github.io/audio/salamander/C4.mp3";

    // â˜… AudioWorkletProcessorã®å®Ÿè£…ã‚’æ–‡å­—åˆ—ã§ç”¨æ„ã™ã‚‹ (æœ¬æ¥ã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒç†æƒ³)
    const workletCode = `
      class SamplePlayerProcessor extends AudioWorkletProcessor {
        constructor() {
          super();
          // ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’Float32Arrayã§ä¿æŒã™ã‚‹ã«ã‚ƒ(ãƒ¢ãƒãƒ©ãƒ«å‰æ)
          this.sampleData = null;
          this.sampleRateHost = sampleRate; // ãƒ›ã‚¹ãƒˆå´ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ
          this.voices = {}; // noteNumberã”ã¨ã«å†ç”Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒã¤ã«ã‚ƒ

          // port.onmessage ã§ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚„å‘½ä»¤ã‚’å—ã‘å–ã‚‹ã«ã‚ƒ
          this.port.onmessage = (e) => {
            const msg = e.data;
            if (msg.type === "loadSample") {
              // ã‚µãƒ³ãƒ—ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ‡ãƒ¼ã‚¿ (Float32Array) ã‚’å—ã‘å–ã£ã¦ä¿å­˜
              this.sampleData = msg.buffer;
            } else if (msg.type === "noteOn") {
              // å†ç”Ÿé–‹å§‹
              const noteNumber = msg.noteNumber;
              // ä½ç½®ã‚’0ã«ã—ã¦å†ç”Ÿé–‹å§‹ã™ã‚‹ã«ã‚ƒ
              // velocityã¯ä¸€æ—¦ç„¡è¦–ã—ã¦ä¸€å®šéŸ³é‡ã«ã™ã‚‹ã‹ã€
              // ã“ã“ã§å£°ã”ã¨ã«ã‚²ã‚¤ãƒ³ç®¡ç†ã—ã¦ã‚‚OK
              this.voices[noteNumber] = {
                position: 0,
                // ã‚µãƒ³ãƒ—ãƒ«æœ¬æ¥ã®ãƒ”ãƒƒãƒã¯C4(60) â†’ freq=261.63Hzãã‚‰ã„
                // ãã®å‘¨æ³¢æ•°æ¯”ã§å†ç”Ÿé€Ÿåº¦ã‚’æ±ºã‚ã‚‹ã«ã‚ƒ
                playbackRate: Math.pow(2, (noteNumber - 60) / 12)
              };
            } else if (msg.type === "noteOff") {
              // ãƒœã‚¤ã‚¹ã‚’æ¶ˆã™(ç°¡æ˜“å®Ÿè£…ã§å³åœæ­¢)
              const noteNumber = msg.noteNumber;
              delete this.voices[noteNumber];
            }
          };
        }

        process(inputs, outputs, parameters) {
          const output = outputs[0];
          const channelData = output[0]; // ãƒ¢ãƒãƒ©ãƒ«å‡ºåŠ›

          if (!this.sampleData) {
            // ã‚µãƒ³ãƒ—ãƒ«æœªãƒ­ãƒ¼ãƒ‰ãªã‚‰å…¨éƒ¨0ã‚¯ãƒªã‚¢
            channelData.fill(0);
            return true;
          }

          // 1ã‚µãƒ³ãƒ—ãƒ«ã”ã¨ã«å…¨ã¦ã®voiceã‚’åˆæˆã—ã¦æ›¸ãè¾¼ã‚€ã«ã‚ƒ
          for (let i = 0; i < channelData.length; i++) {
            let out = 0;
            for (let noteNumber in this.voices) {
              const voice = this.voices[noteNumber];
              // voice.position ãŒæ•´æ•°ã˜ã‚ƒãªã„ã‹ã‚‰ã€å°æ•°éƒ¨åˆ†ã‚’floorã—ã¦ã‚µãƒ³ãƒ—ãƒ«å‚ç…§
              const idx = Math.floor(voice.position);

              // ã‚µãƒ³ãƒ—ãƒ«éŸ³ãŒçµ‚ç«¯ã‚’è¶…ãˆãŸã‚‰ãƒ«ãƒ¼ãƒ—ã—ãªã„ã§æ­¢ã‚ã‚‹
              if (idx >= this.sampleData.length) {
                // æ­¢ã‚ã‚‹
                delete this.voices[noteNumber];
                continue;
              }

              // ã¨ã‚Šã‚ãˆãšç·šå½¢è£œé–“ãªã—ã§è¿‘ä¼¼å€¤ã‚’å–ã‚‹(ã‚¬ã‚¯ã‚¬ã‚¯éŸ³ç¨‹ã ãŒâ€¦)
              const sampleVal = this.sampleData[idx];

              out += sampleVal; // velocityã‚„éŸ³é‡ã¯ä¸€æ—¦ç„¡è¦–ã—ã¦åˆè¨ˆ

              // å†ç”Ÿé€Ÿåº¦ã«å¿œã˜ã¦positionã‚’é€²ã‚ã‚‹
              voice.position += voice.playbackRate;
            }
            // å‡ºåŠ›
            channelData[i] = out * 0.3; // å…¨ä½“éŸ³é‡ã¡ã‚‡ã„ä¸‹ã’
          }

          return true;
        }
      }

      registerProcessor('sample-player-processor', SamplePlayerProcessor);
    `;

    let audioCtx;
    let sampleNode;
    let sampleGain;

    // ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦Float32Arrayã«ã™ã‚‹é–¢æ•°
    async function loadSample(url) {
      const res = await fetch(url);
      const arrayBuffer = await res.arrayBuffer();
      // AudioContextã§decodeAudioDataã—ã¦ã‚¹ãƒ†ãƒ¬ã‚ªâ†’ãƒ¢ãƒãƒ©ãƒ«ã«å¤‰æ›ã—ã¦Float32Arrayã¸
      const audioBuf = await audioCtx.decodeAudioData(arrayBuffer);
      // ã¾ãšã¯Lãƒãƒ£ãƒ³ãƒãƒ«ã ã‘æŠ½å‡º(æœ¬å½“ã¯ã‚¹ãƒ†ãƒ¬ã‚ªåˆæˆã‚‚ã‚„ã‚ã†ã¨æ€ãˆã°ã§ãã‚‹)
      const chData = audioBuf.getChannelData(0);
      // ãã®ã¾ã¾Float32Arrayã§OK
      return chData;
    }

    async function startAudioWorklet() {
      // latencyHint: "interactive" ã§AudioContextã‚’ä½œã‚‹ã«ã‚ƒ
      audioCtx = new AudioContext({ latencyHint: 'interactive' });
      // AudioWorkletã‚’ç™»éŒ²
      await audioCtx.audioWorklet.addModule(
        URL.createObjectURL(new Blob([workletCode], {type: 'application/javascript'}))
      );
      // Nodeä½œæˆ
      sampleNode = new AudioWorkletNode(audioCtx, 'sample-player-processor');

      // ãƒã‚¹ã‚¿ãƒ¼ã‚²ã‚¤ãƒ³
      sampleGain = audioCtx.createGain();
      sampleGain.gain.value = 1.0; // å…¨éŸ³é‡
      sampleNode.connect(sampleGain).connect(audioCtx.destination);

      // ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦AudioWorkletã«é€ã‚‹ã«ã‚ƒ
      const sampleData = await loadSample(SAMPLE_URL);
      sampleNode.port.postMessage({
        type: "loadSample",
        buffer: sampleData
      });
    }

    // MIDIå‡¦ç†
    async function startMIDI() {
      const midiAccess = await navigator.requestMIDIAccess();
      for (let input of midiAccess.inputs.values()) {
        input.onmidimessage = (msg) => {
          const [status, data1, data2] = msg.data;
          const command = status & 0xf0;
          if (command === 0x90 && data2 > 0) {
            // NoteOn
            sampleNode.port.postMessage({
              type: "noteOn",
              noteNumber: data1
            });
          } else if (command === 0x80 || (command === 0x90 && data2 === 0)) {
            // NoteOff
            sampleNode.port.postMessage({
              type: "noteOff",
              noteNumber: data1
            });
          }
        };
      }
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
      await startAudioWorklet();
      await audioCtx.resume();
      await startMIDI();
      alert("AudioWorkletã‚µãƒ³ãƒ—ãƒ©ãƒ¼èµ·å‹•ã«ã‚ƒï¼ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¼¾ã„ã¦ã¿ã¦ã«ã‚ƒï½ğŸ±");
    });
  </script>
</body>
</html>
